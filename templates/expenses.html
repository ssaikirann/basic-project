{% extends 'base.html' %}

{% block title %}Expenses - Finance Tracker{% endblock %}

{% block content %}
  <h2 class="mb-3">Manage Expenses</h2>

  <div class="row">
    <div class="col-md-5">
      <div class="card p-3 mb-3">
        <h5>Add New Expense</h5>
        <form id="expenseForm">
          <div class="mb-2">
            <label class="form-label" for="category">Category</label>
            <input class="form-control" type="text" id="category" name="category" placeholder="e.g., food, rent" required>
          </div>
          <div class="mb-2">
            <label class="form-label" for="amount">Amount</label>
            <input class="form-control" type="number" id="amount" name="amount" step="0.01" required>
          </div>
          <div class="mb-2">
            <label class="form-label" for="currency">Currency</label>
            <select id="currency" name="currency" class="form-select"></select>
          </div>
          <div class="mb-2">
            <label class="form-label" for="note">Note</label>
            <textarea class="form-control" id="note" name="note" rows="2"></textarea>
          </div>
          <button class="btn btn-primary">Add Expense</button>
        </form>
      </div>
    </div>

    <div class="col-md-7">
      <div class="card p-3">
        <h5>Expense List</h5>
        <div id="expensesList">Loading expenses...</div>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
<script>
async function loadExpenses() {
  try {
    const response = await fetch('/api/expenses');
    const expenses = await response.json();
    if (expenses.length === 0) { document.getElementById('expensesList').innerHTML = '<p>No expenses recorded yet</p>'; return; }
    let html = '<table class="table"><thead><tr><th>Category</th><th>Amount</th><th>Note</th><th>Date</th><th>Action</th></tr></thead><tbody>';
    expenses.forEach((expense, index) => { const cur = expense.currency || 'USD'; html += `<tr><td>${expense.category}</td><td>${cur} ${Number(expense.amount).toFixed(2)}</td><td>${expense.note}</td><td>${expense.date}</td><td><button class="btn btn-danger btn-sm" onclick="deleteExpense(${index})">Delete</button></td></tr>`; });
    html += '</tbody></table>';
    document.getElementById('expensesList').innerHTML = html;
  } catch (error) { console.error('Error loading expenses:', error); document.getElementById('expensesList').innerHTML = '<p>Error loading expenses</p>'; }
}

document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('expenseForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = { category: document.getElementById('category').value, amount: document.getElementById('amount').value, currency: document.getElementById('currency').value, note: document.getElementById('note').value };
    try {
      const response = await fetch('/api/expenses', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(formData) });
      if (response.ok) { document.getElementById('expenseForm').reset(); loadExpenses(); alert('Expense added successfully!'); } else { alert('Error adding expense'); }
    } catch (error) { console.error('Error:', error); alert('Error adding expense'); }
  });
  loadExpenses();

  window.deleteExpense = async function(index) { if (!confirm('Are you sure?')) return; try { const response = await fetch(`/api/expenses/${index}`, { method: 'DELETE' }); if (response.ok) { loadExpenses(); alert('Expense deleted successfully!'); } else { alert('Error deleting expense'); } } catch (e) { console.error('Error:', e); alert('Error deleting expense'); } };

  async function loadCurrencies() { try { const res = await fetch('/api/currencies'); const data = await res.json(); const sel = document.getElementById('currency'); data.symbols.forEach(s => { const opt = document.createElement('option'); opt.value = s; opt.text = s; sel.appendChild(opt); }); if (data.symbols.includes('USD')) sel.value = 'USD'; } catch (e) { console.warn('Could not load currencies', e); const sel = document.getElementById('currency'); ['USD','EUR','INR'].forEach(s => { const opt = document.createElement('option'); opt.value=s; opt.text=s; sel.appendChild(opt);}); } }

  loadCurrencies();
});
</script>
{% endblock %}
