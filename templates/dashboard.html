{% extends 'base.html' %}

{% block title %}Dashboard - Finance Tracker{% endblock %}

{% block head %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
    <h2 class="mb-3">Financial Dashboard</h2>

    <div class="mb-3 d-flex gap-2 align-items-center">
        <label for="targetCurrency" class="mb-0">Show totals in:</label>
        <select id="targetCurrency" class="form-select w-auto"></select>
        <button id="convertBtn" class="btn btn-info">Convert</button>
        <div id="convertedTotals" class="ms-3"></div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card p-3">
                <h6>Total Expenses</h6>
                <div class="h4">{{ "%.2f"|format(total_expenses) }}</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3">
                <h6>Total Investments</h6>
                <div class="h4">{{ "%.2f"|format(total_investments) }}</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3">
                <h6>Expense Count</h6>
                <div class="h4">{{ expenses|length }}</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3">
                <h6>Investment Count</h6>
                <div class="h4">{{ investments|length }}</div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card p-3">
                <h6>Expenses by Category</h6>
                <canvas id="categoryChart"></canvas>
            </div>
        </div>
        <div class="col-md-6 mb-4">
            <div class="card p-3">
                <h6>Investment Distribution</h6>
                <canvas id="investmentChart"></canvas>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="card p-3">
                <h6>Latest Expenses</h6>
                {% if expenses %}
                    <ul class="list-group list-group-flush">
                        {% for expense in expenses[-5:] %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="fw-bold">{{ expense.category }}</div>
                                    <div class="text-muted small">{{ expense.date }}</div>
                                </div>
                                <div>{{ expense.currency or 'USD' }} {{ "%.2f"|format(expense.amount) }}</div>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p>No expenses recorded</p>
                {% endif %}
            </div>
        </div>
        <div class="col-md-6">
            <div class="card p-3">
                <h6>Latest Investments</h6>
                {% if investments %}
                    <ul class="list-group list-group-flush">
                        {% for investment in investments[-5:] %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="fw-bold">{{ investment.type }}</div>
                                    <div class="text-muted small">{{ investment.date }}</div>
                                </div>
                                <div>{{ investment.currency or 'USD' }} {{ "%.2f"|format(investment.amount) }}</div>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p>No investments recorded</p>
                {% endif %}
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
async function loadDashboard() {
    try {
        const response = await fetch('/api/stats');
        const stats = await response.json();
        if (Object.keys(stats.category_breakdown).length > 0) {
            const categoryCtx = document.getElementById('categoryChart').getContext('2d');
            new Chart(categoryCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(stats.category_breakdown),
                    datasets: [{ data: Object.values(stats.category_breakdown), backgroundColor: ['#FF6384','#36A2EB','#FFCE56','#4BC0C0','#9966FF','#FF9F40'] }]
                },
                options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
            });
        }
        if (Object.keys(stats.investment_types).length > 0) {
            const investmentCtx = document.getElementById('investmentChart').getContext('2d');
            new Chart(investmentCtx, { type: 'pie', data: { labels: Object.keys(stats.investment_types), datasets: [{ data: Object.values(stats.investment_types), backgroundColor: ['#4BC0C0','#FF6384','#36A2EB','#FFCE56','#9966FF'] }] }, options: { responsive: true, plugins: { legend: { position: 'bottom' } } } });
        }
    } catch (error) { console.error('Error loading dashboard:', error); }
}

async function loadCurrencies() {
    try {
        const res = await fetch('/api/currencies');
        const data = await res.json();
        const sel = document.getElementById('targetCurrency');
        data.symbols.forEach(s => { const opt = document.createElement('option'); opt.value = s; opt.text = s; sel.appendChild(opt); });
        if (data.symbols.includes('USD')) sel.value = 'USD';
    } catch (e) { ['USD','EUR','INR'].forEach(s => { const opt = document.createElement('option'); opt.value=s; opt.text=s; document.getElementById('targetCurrency').appendChild(opt);}); }
}

document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('convertBtn').addEventListener('click', async () => {
        const tgt = document.getElementById('targetCurrency').value;
        try {
            const resp = await fetch(`/api/stats?target_currency=${tgt}`);
            const data = await resp.json();
            if (data.total_expenses_converted !== undefined) {
                document.getElementById('convertedTotals').innerText = `Expenses: ${data.converted_currency} ${data.total_expenses_converted.toFixed(2)} | Investments: ${data.converted_currency} ${data.total_investments_converted.toFixed(2)}`;
            } else {
                document.getElementById('convertedTotals').innerText = data.conversion_error || 'Conversion unavailable';
            }
        } catch (e) { document.getElementById('convertedTotals').innerText = 'Conversion error'; }
    });
    loadCurrencies();
    loadDashboard();
});
</script>
{% endblock %}
