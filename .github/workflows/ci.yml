name: Finance Tracker CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Stage 2: Build
  build:
    runs-on: ubuntu-latest
    name: Build Python Application
    # no prior job dependency

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Display Python version
        run: python -c "import sys; print(sys.version)"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Verify application imports
        run: python -c "import finance_tracker; print('✓ Application imports successfully')"

  # Stage 3: Test
  test:
    runs-on: ubuntu-latest
    name: Run Tests with Coverage
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests with pytest
        run: pytest test_finance_tracker.py -v

      - name: Run tests with coverage
        run: pytest test_finance_tracker.py --cov=finance_tracker --cov-report=xml --cov-report=html

      - name: Display coverage report
        run: |
          echo "=== Coverage Report ==="
          coverage report

      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: unittests
          fail_ci_if_error: false

  # Stage 4: Code Quality
  code-quality:
    runs-on: ubuntu-latest
    name: Code Quality Checks
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install flake8 pylint

      - name: Run Flake8 linting
        run: flake8 finance_tracker.py test_finance_tracker.py --max-line-length=120 --count --statistics
        continue-on-error: true

      - name: Run Pylint
        run: pylint finance_tracker.py --exit-zero --disable=C0111
        continue-on-error: true

  # Stage 5: Infrastructure Tests
  infrastructure-tests:
    runs-on: ubuntu-latest
    name: Infrastructure Validation Tests
    needs: [build, code-quality]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.0

      - name: Make infrastructure test scripts executable
        run: |
          chmod +x scripts/infra_tests.sh
          chmod +x scripts/terraform_validate.sh

      - name: Run infrastructure tests
        run: bash scripts/infra_tests.sh

      - name: Run Terraform validation
        run: bash scripts/terraform_validate.sh

  # Stage 6: Docker Build and Push
  docker-build:
    runs-on: ubuntu-latest
    name: Docker Build and Registry Push
    needs: [test, code-quality, infrastructure-tests]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to Container Registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha

      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Image digest
        run: echo ${{ steps.docker_build.outputs.digest }}

  # Stage 7: Kubernetes Deployment (Minikube)
  kubernetes-deploy:
    runs-on: ubuntu-latest
    name: Kubernetes Deployment to Minikube
    needs: docker-build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Minikube
        uses: medyagh/setup-minikube@master
        with:
          start-args: '--memory=4096 --cpus=2'
          minikube-version: latest

      - name: Verify Minikube
        run: |
          minikube status
          kubectl version --client

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.0

      - name: Generate Kubernetes manifests with Terraform
        run: |
          cd terraform
          terraform init -upgrade
          terraform plan -var="docker_image_tag=main" -out=tfplan
          terraform apply -auto-approve tfplan
          cd ..

      - name: Make K8s deployment script executable
        run: chmod +x scripts/k8s_deploy_test.sh

      - name: Deploy to Minikube
        run: bash scripts/k8s_deploy_test.sh

      - name: Verify Minikube deployment
        run: |
          echo "=== Deployment Status ==="
          kubectl get all -n finance-tracker
          echo ""
          echo "=== Pod Logs ==="
          kubectl logs -n finance-tracker deployment/finance-tracker --tail=50 || true

  # Stage 8: Deployment Preparation
  deploy-prep:
    runs-on: ubuntu-latest
    name: Deployment Artifacts and Release Notes
    needs: [test, code-quality, infrastructure-tests]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create deployment artifact
        run: |
          mkdir -p dist
          cp finance_tracker.py dist/
          cp requirements.txt dist/
          cp Dockerfile dist/
          cp docker-compose.yml dist/
          cp -r terraform dist/
          cp -r scripts dist/
          echo "Build completed successfully at $(date)" > dist/BUILD_INFO.txt

      - name: Display artifact contents
        run: ls -laR dist/

      - name: Create comprehensive release notes
        run: |
          echo "# Finance Tracker Release v1.0.0" > RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "## Build Information" >> RELEASE_NOTES.md
          echo "- **Build Date**: $(date)" >> RELEASE_NOTES.md
          echo "- **Commit**: ${{ github.sha }}" >> RELEASE_NOTES.md
          echo "- **Branch**: ${{ github.ref }}" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "## Deployment Stack" >> RELEASE_NOTES.md
          echo "- Docker: Containerized application" >> RELEASE_NOTES.md
          echo "- Kubernetes: Minikube deployment" >> RELEASE_NOTES.md
          echo "- Terraform: Infrastructure as Code" >> RELEASE_NOTES.md
          echo "- Tests: Comprehensive test coverage" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "## Features" >> RELEASE_NOTES.md
          echo "- Expense tracking" >> RELEASE_NOTES.md
          echo "- Investment tracking" >> RELEASE_NOTES.md
          echo "- JSON data persistence" >> RELEASE_NOTES.md
          echo "- Docker containerization" >> RELEASE_NOTES.md
          echo "- Kubernetes orchestration" >> RELEASE_NOTES.md
          echo "- Terraform IaC" >> RELEASE_NOTES.md
          echo "- Automated CI/CD pipeline" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "## Deployment Instructions" >> RELEASE_NOTES.md
          echo "### Local Docker" >> RELEASE_NOTES.md
          echo "\`\`\`bash" >> RELEASE_NOTES.md
          echo "docker-compose up -d" >> RELEASE_NOTES.md
          echo "\`\`\`" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "### Minikube Kubernetes" >> RELEASE_NOTES.md
          echo "\`\`\`bash" >> RELEASE_NOTES.md
          echo "minikube start" >> RELEASE_NOTES.md
          echo "cd terraform && terraform init && terraform apply" >> RELEASE_NOTES.md
          echo "kubectl apply -f k8s-config/" >> RELEASE_NOTES.md
          echo "\`\`\`" >> RELEASE_NOTES.md
          cat RELEASE_NOTES.md

      - name: Summary
        run: |
          echo "=== Deployment Ready ===" 
          echo "✓ All CI/CD stages completed successfully"
          echo "✓ Docker image built and pushed"
          echo "✓ Kubernetes manifests generated"
          echo "✓ Deployment artifacts prepared"
          echo "✓ Release notes created"